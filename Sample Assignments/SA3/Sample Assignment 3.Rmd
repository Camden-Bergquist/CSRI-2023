---
title: "Regression modeling: 2 - Correlation"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, message=FALSE, warning=FALSE, include=FALSE}

library(learnr)
library(tidyverse)
library(openintro)
library(googlesheets4)

tutorial_options(exercise.eval = FALSE)

# Initialize a data frame.
df <- data.frame(user_id = character(),
                 question = character(),
                 answer = character(), 
                 correct = logical(),
                 stringsAsFactors = FALSE) # Set this to avoid factors

# Define a custom event recorder function.
event_recorder <- function(tutorial_id, tutorial_version, user_id, event, data) {
  if (event %in% c("exercise_submission", "question_submission")) {
    # Add the new row to the dataframe
    new_row <- data.frame(user_id = user_id,
                          question = data$question,
                          answer = data$answer, 
                          correct = ifelse(data$correct, TRUE, FALSE),
                          stringsAsFactors = FALSE) # Set this to avoid factors

    # Combine the existing data frame with the new row
    df <<- rbind(df, new_row)
    
    # If it's the final question or exercise, write to Google Sheets
      if(data$question == "Which of the following conclusions is not a valid statistical interpretation of these results?") {
      ss <- gs4_create(name = "Assignment 3 Log")
      sheet_write(dplyr::select(df, user_id, question, answer, correct), ss = ss,
                  sheet = "Sheet1")
    }
  }
}

# Set the global option
options(tutorial.event_recorder = event_recorder)


knitr::opts_chunk$set(echo = FALSE, 
                      fig.align = "center", 
                      fig.height = 3, 
                      fig.width = 5,
                      message = FALSE, 
                      warning = FALSE)

anscombe <- datasets::anscombe %>%
  mutate(id = 1:nrow(.)) %>%
  gather(key = "key", value = "val", -id) %>%
  separate(key, into = c("variable", "set"), sep = 1) %>%
  spread(key = variable, value = val)
```

## Perception of Correlation

Recall the scatterplot between the poverty rate of counties in the United States and the high school graduation rate in those counties from the <a href="https://openintro.shinyapps.io/ims-03-model-01/#section-your-turn-1" target="_blank">previous lesson</a>. 

```{r mr3-pre}
ggplot(data = county_complete,
       aes(x = hs_grad_2010, y = poverty_2010)) +
  geom_point()
```

```{r mc3}
question("Which of the following values is the correct correlation between poverty rate and high school graduation rate?",
  answer("-0.861", message = "Close, but a correlation of -0.861 seems a bit too strong for the relationship shown on the plot."),
  answer("-0.681", correct = TRUE, message = "The relationship is clearly negative, not too strong, and not too weak..."),
  answer("-0.186", message = "Not quite!"),
  answer("0.186", message = "Incorrect, the slope is not positive!"),
  answer("0.681", message = "Wrong, the relationship isn't positive!"),
  answer("0.861", message = "Try again!"),
  allow_retry = TRUE
)
```

## Graph Interpretation 

Recall that you previously determined the value of the correlation coefficient between the poverty rate of counties in the United States and the high school graduation rate in those counties was `r cor(county_complete$hs_grad_2010, county_complete$poverty_2010)`. 

```{r mc4-pre}
ggplot(data = county_complete, 
       aes(x = hs_grad_2010, y = poverty_2010)) + 
  geom_point()
```

```{r mc4}
question("Choose the correct interpretation of this value.",
  answer("People who graduate from high school are less likely to be poor.", message = 'Beware the ecological fallacy!' ),
  answer("Counties with lower high school graduation rates are likely to have lower poverty rates.", message = 'Check the sign!'),
  answer("Counties with lower high school graduation rates are likely to have higher poverty rates.", correct = TRUE, message = "Correlation doesn't imply causation, which rules out a couple of the options!"),
  answer("Because the correlation is negative, there is no relationship between poverty rates and high school graduate rates. ", message = 'Negative correlation is still correlation!' ), 
  answer("Having a higher percentage of high school graduates in a county results in that county having lower poverty rates.", message = 'Correlation does not imply causation!'),
  allow_retry = TRUE
)
```


## Correlation and Causation

In the San Francisco Bay Area from 1960-1967, the correlation between the birthweight of 1,236 babies and the length of their gestational period was  0.408. 

```{r mc5}
question("Which of the following conclusions is not a valid statistical interpretation of these results?",
  answer("We observed that babies with longer gestational periods tended to be heavier at birth.", message = "This statement **is** a valid interpretation of the results! It uses with 'tended' wording carefully to prevent a causal implication."),
  answer("It may be that a longer gestational period contributes to a heavier birth weight among babies, but a randomized, controlled experiment is needed to confirm this observation.", message = "This statement **is** a valid interpretation of the results! It uses a cautionary language and refers explicitly to a randomized experiment to avoid that correlation also implies causation."),
  answer("Staying in the womb longer causes babies to be heavier when they are born.", correct = TRUE, message =  "Correlation does not imply causation! This is the only **wrong interpretation**. All the other interpretations choose words carefully ('tend', 'experiment needed', 'beware of confounding factors', etc.) to prevent a causal implication."),
  answer("These data suggest that babies with longer gestational periods tend to be heavier at birth, but there are many potential confounding factors that were not taken into account.", message = "This statement **is** a valid interpretation of the results! It uses with 'tend to be' wording carefully and refers explicitly to confounding factors."),
  allow_retry = TRUE
)
```
