---
title: "Analysis Script"
author: "Camden"
date: "2023-05-25"
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(knitr)

knitr::opts_chunk$set(echo = FALSE)
```

```{r Load}
# Load data from a local CSV file
data <- read.csv('./data/TestData2.csv')

# Separate columns into problems, answers, correctness and points
problems <- data %>%
  select(user_id, starts_with("Q") & ends_with("_problem")) %>%
  pivot_longer(-user_id, names_to = "question", values_to = "problem", names_pattern = "(Q\\d+)_problem")

answers <- data %>%
  select(user_id, starts_with("Q") & ends_with("_answer")) %>%
  pivot_longer(-user_id, names_to = "question", values_to = "answer", names_pattern = "(Q\\d+)_answer")

correctness <- data %>%
  select(user_id, starts_with("Q") & ends_with("_correct")) %>%
  pivot_longer(-user_id, names_to = "question", values_to = "correct", names_pattern = "(Q\\d+)_correct")

points <- data %>%
  select(user_id, starts_with("Q") & ends_with("_points")) %>%
  pivot_longer(-user_id, names_to = "question", values_to = "points", names_pattern = "(Q\\d+)_points")

# Combine reshaped data
data_long <- full_join(problems, answers, by = c("user_id", "question")) %>%
  full_join(correctness, by = c("user_id", "question")) %>%
  full_join(points, by = c("user_id", "question"))

# Convert correct column to logical and points to integer
data_long$correct <- as.logical(data_long$correct)
data_long$points <- as.integer(data_long$points)

```

``` {r Table, include = FALSE}
kable(data_long)
```

``` {r Aggregation}
# Aggregate data by user_id and correct
user_data <- data_long %>%
  group_by(user_id, correct) %>%
  summarise(n = n(), .groups = 'drop')

# Calculate the number of correct answers per user
correct_answers_user <- user_data %>%
  filter(correct == TRUE) %>%
  rename(correct_count = n) %>%
  select(-correct)

# Join correct_counts back to user_data
user_data <- left_join(user_data, correct_answers_user, by = "user_id")

# Reorder the levels of the factor variable "user_id" based on the number of correct answers
user_data$user_id <- forcats::fct_reorder(user_data$user_id, user_data$correct_count)


# Aggregate data by question and correct
question_data <- data_long %>%
  group_by(question, correct) %>%
  summarise(n = n(), .groups = 'drop')

# Calculate the number of correct answers per question
correct_answers <- question_data %>%
  filter(correct == TRUE) %>%
  rename(correct_count = n) %>%
  select(-correct)

# Join correct_counts back to question_data
question_data <- left_join(question_data, correct_answers, by = "question")

# Reorder the levels of the factor variable "question" based on the number of correct answers
question_data$question <- forcats::fct_reorder(question_data$question, question_data$correct_count)

```

## Submissions by User:

``` {r User Visual}
# Bar plot of submissions by user, colored by whether they are correct or not
ggplot(user_data, aes(x = user_id, y = n, fill = correct)) +
  geom_bar(stat = 'identity', position = 'stack') +
  labs(x = "User ID", y = "Count", fill = "Correctness") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Submissions by Question:

``` {r Question Visual}
# Bar plot of submissions by question, colored by whether they are correct or not
ggplot(question_data, aes(x = as.factor(question), y = n, fill = correct)) +
  geom_bar(stat = 'identity', position = 'stack') +
  labs(x = "Question", y = "Count", fill = "Correctness") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

``` {r Incorrect Table, include = FALSE}
# Calculate the number of correct answers per question
incorrect_answers <- question_data %>%
  filter(correct == FALSE)

# Sort questions by the number of correct answers
sorted_questions <- incorrect_answers %>%
  arrange(desc(n))

# Display in a kable table
knitr::kable(sorted_questions, caption = "Questions Sorted by Number of Correct Answers")
```

```{r Grade Calculation}

# Calculate total points earned by each student
total_points_earned <- data_long %>%
  filter(correct == TRUE) %>%
  group_by(user_id) %>%
  summarise(total_earned = sum(points, na.rm = TRUE))

# Calculate total possible points for the test
total_points_possible <- data_long %>%
  group_by(user_id) %>%
  summarise(total_possible = sum(points, na.rm = TRUE))

# Join total_points_earned and total_points_possible
grading <- full_join(total_points_earned, total_points_possible, by = "user_id")

# Calculate percentage of points earned
grading <- grading %>%
  mutate(percentage = (total_earned / total_possible) * 100)

# Assign letter grade
grading <- grading %>%
  mutate(letter_grade = case_when(
    percentage >= 93 ~ "A",
    percentage >= 80 ~ "B",
    percentage >= 70 ~ "C",
    percentage >= 60 ~ "D",
    TRUE ~ "F"
  ))

# Sort by percentage, highest to lowest
grading <- grading %>%
  arrange(desc(percentage))

kable(grading)

```